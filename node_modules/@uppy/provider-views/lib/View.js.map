{"version":3,"names":["getFileType","isPreviewSupported","remoteFileObjToLocal","View","constructor","plugin","opts","filterItems","items","state","getPluginState","filterInput","filter","folder","name","toLowerCase","indexOf","recordShiftKeyPress","e","isShiftKeyPressed","shiftKey","toggleCheckbox","file","stopPropagation","preventDefault","currentTarget","focus","folders","files","concat","lastCheckbox","currentSelection","prevIndex","currentIndex","newSelection","slice","reducedNewSelection","item","uppy","restrictionError","validateRestrictions","getFiles","push","info","message","infoTimeout","setPluginState","Set","isChecked","id","some","provider","isHandlingScroll","preFirstRender","bind","handleError","clearSelection","cancelPicking","didFirstRender","onFirstRender","shouldHandleScroll","event","scrollHeight","scrollTop","offsetHeight","target","scrollPosition","dashboard","getPlugin","hideAllPanels","error","i18n","log","toString","isAuthError","details","getTagFile","tagFile","source","data","type","mimeType","isRemote","meta","body","fileId","remote","companionUrl","url","fileUrl","requestPath","providerOptions","providerName","fileType","preview","thumbnail","author","authorName","String","authorUrl","setLoading","loading"],"sources":["View.js"],"sourcesContent":["import getFileType from '@uppy/utils/lib/getFileType'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\nimport remoteFileObjToLocal from '@uppy/utils/lib/remoteFileObjToLocal'\n\nexport default class View {\n  constructor (plugin, opts) {\n    this.plugin = plugin\n    this.provider = opts.provider\n\n    this.isHandlingScroll = false\n\n    this.preFirstRender = this.preFirstRender.bind(this)\n    this.handleError = this.handleError.bind(this)\n    this.clearSelection = this.clearSelection.bind(this)\n    this.cancelPicking = this.cancelPicking.bind(this)\n  }\n\n  preFirstRender () {\n    this.plugin.setPluginState({ didFirstRender: true })\n    this.plugin.onFirstRender()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  shouldHandleScroll (event) {\n    const { scrollHeight, scrollTop, offsetHeight } = event.target\n    const scrollPosition = scrollHeight - (scrollTop + offsetHeight)\n\n    return scrollPosition < 50 && !this.isHandlingScroll\n  }\n\n  clearSelection () {\n    this.plugin.setPluginState({ currentSelection: [], filterInput: '' })\n  }\n\n  cancelPicking () {\n    this.clearSelection()\n\n    const dashboard = this.plugin.uppy.getPlugin('Dashboard')\n\n    if (dashboard) {\n      dashboard.hideAllPanels()\n    }\n  }\n\n  handleError (error) {\n    const { uppy } = this.plugin\n    const message = uppy.i18n('companionError')\n\n    uppy.log(error.toString())\n\n    if (error.isAuthError) {\n      return\n    }\n\n    uppy.info({ message, details: error.toString() }, 'error', 5000)\n  }\n\n  // todo document what is a \"tagFile\" or get rid of this concept\n  getTagFile (file) {\n    const tagFile = {\n      id: file.id,\n      source: this.plugin.id,\n      data: file,\n      name: file.name || file.id,\n      type: file.mimeType,\n      isRemote: true,\n      meta: {},\n      body: {\n        fileId: file.id,\n      },\n      remote: {\n        companionUrl: this.plugin.opts.companionUrl,\n        url: `${this.provider.fileUrl(file.requestPath)}`,\n        body: {\n          fileId: file.id,\n        },\n        providerOptions: this.provider.opts,\n        providerName: this.provider.name,\n        provider: this.provider.provider,\n      },\n    }\n\n    const fileType = getFileType(tagFile)\n\n    // TODO Should we just always use the thumbnail URL if it exists?\n    if (fileType && isPreviewSupported(fileType)) {\n      tagFile.preview = file.thumbnail\n    }\n\n    if (file.author) {\n      if (file.author.name != null) tagFile.meta.authorName = String(file.author.name)\n      if (file.author.url) tagFile.meta.authorUrl = file.author.url\n    }\n\n    return tagFile\n  }\n\n  filterItems = (items) => {\n    const state = this.plugin.getPluginState()\n    if (!state.filterInput || state.filterInput === '') {\n      return items\n    }\n    return items.filter((folder) => {\n      return folder.name.toLowerCase().indexOf(state.filterInput.toLowerCase()) !== -1\n    })\n  }\n\n  recordShiftKeyPress = (e) => {\n    this.isShiftKeyPressed = e.shiftKey\n  }\n\n  /**\n   * Toggles file/folder checkbox to on/off state while updating files list.\n   *\n   * Note that some extra complexity comes from supporting shift+click to\n   * toggle multiple checkboxes at once, which is done by getting all files\n   * in between last checked file and current one.\n   */\n  toggleCheckbox = (e, file) => {\n    e.stopPropagation()\n    e.preventDefault()\n    e.currentTarget.focus()\n    const { folders, files } = this.plugin.getPluginState()\n    const items = this.filterItems(folders.concat(files))\n    // Shift-clicking selects a single consecutive list of items\n    // starting at the previous click.\n    if (this.lastCheckbox && this.isShiftKeyPressed) {\n      const { currentSelection } = this.plugin.getPluginState()\n      const prevIndex = items.indexOf(this.lastCheckbox)\n      const currentIndex = items.indexOf(file)\n      const newSelection = (prevIndex < currentIndex)\n        ? items.slice(prevIndex, currentIndex + 1)\n        : items.slice(currentIndex, prevIndex + 1)\n      const reducedNewSelection = []\n\n      // Check restrictions on each file in currentSelection,\n      // reduce it to only contain files that pass restrictions\n      for (const item of newSelection) {\n        const { uppy } = this.plugin\n        const restrictionError = uppy.validateRestrictions(\n          remoteFileObjToLocal(item),\n          [...uppy.getFiles(), ...reducedNewSelection],\n        )\n\n        if (!restrictionError) {\n          reducedNewSelection.push(item)\n        } else {\n          uppy.info({ message: restrictionError.message }, 'error', uppy.opts.infoTimeout)\n        }\n      }\n      this.plugin.setPluginState({ currentSelection: [...new Set([...currentSelection, ...reducedNewSelection])] })\n      return\n    }\n\n    this.lastCheckbox = file\n    const { currentSelection } = this.plugin.getPluginState()\n    if (this.isChecked(file)) {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.filter((item) => item.id !== file.id),\n      })\n    } else {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.concat([file]),\n      })\n    }\n  }\n\n  isChecked = (file) => {\n    const { currentSelection } = this.plugin.getPluginState()\n    // comparing id instead of the file object, because the reference to the object\n    // changes when we switch folders, and the file list is updated\n    return currentSelection.some((item) => item.id === file.id)\n  }\n\n  setLoading (loading) {\n    this.plugin.setPluginState({ loading })\n  }\n}\n"],"mappings":"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"}