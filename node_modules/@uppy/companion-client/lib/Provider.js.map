{"version":3,"names":["_classPrivateFieldLooseBase","receiver","privateKey","Object","prototype","hasOwnProperty","call","TypeError","id","_classPrivateFieldLooseKey","name","RequestClient","tokenStorage","getName","split","map","s","charAt","toUpperCase","slice","join","_refreshingTokenPromise","_getAuthToken","_removeAuthToken","Provider","constructor","uppy","opts","defineProperty","value","_removeAuthToken2","_getAuthToken2","writable","provider","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","token","Promise","all","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","set","hostname","refreshTokenUrl","fileUrl","request","arguments","err","isAuthError","path","method","uppyAuthToken","undefined","res","post","log","list","directory","get","logout","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionAllowedHosts","pattern","Array","isArray","RegExp","test","companionUrl","replace","URL","origin","getItem","removeItem"],"sources":["Provider.js"],"sourcesContent":["'use strict'\n\nimport RequestClient from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nexport default class Provider extends RequestClient {\n  #refreshingTokenPromise\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  async headers () {\n    const [headers, token] = await Promise.all([super.headers(), this.#getAuthToken()])\n    const authHeaders = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse (response) {\n    super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  async setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  async #getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  async #removeAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth () {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  authUrl (queries = {}) {\n    const params = new URLSearchParams(queries)\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  refreshTokenUrl () {\n    return `${this.hostname}/${this.id}/refresh-token`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  /** @protected */\n  async request (...args) {\n    await this.#refreshingTokenPromise\n\n    try {\n      // throw Object.assign(new Error(), { isAuthError: true }) // testing simulate access token expired (to refresh token)\n      return await super.request(...args)\n    } catch (err) {\n      if (!err.isAuthError) throw err // only handle auth errors (401 from provider)\n\n      await this.#refreshingTokenPromise\n\n      // Many provider requests may be starting at once, however refresh token should only be called once.\n      // Once a refresh token operation has started, we need all other request to wait for this operation (atomically)\n      this.#refreshingTokenPromise = (async () => {\n        try {\n          const response = await super.request({ path: this.refreshTokenUrl(), method: 'POST' })\n          await this.setAuthToken(response.uppyAuthToken)\n        } finally {\n          this.#refreshingTokenPromise = undefined\n        }\n      })()\n\n      await this.#refreshingTokenPromise\n\n      // now retry the request with our new refresh token\n      return super.request(...args)\n    }\n  }\n\n  async fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list (directory) {\n    return this.get(`${this.id}/list/${directory || ''}`)\n  }\n\n  async logout () {\n    const response = await this.get(`${this.id}/logout`)\n    await this.#removeAuthToken()\n    return response\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"],"mappings":"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"}